#!/usr/bin/env bash

# Â© 2020 engel-ch@outlook.com under MIT-license

# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:

# The above copyright notice and this permission notice shall be included in all
# copies or substantial portions of the Software.

# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.

APP=$(basename $0)
#APP_DIR=$(dirname $0)
APP_VERSION="0.3.5"

function err()
{
    echo "$@" > /dev/stderr
}

function usage()
{
    err "USAGE:"
    err "-   $APP version|-V                                                        # app-name:versionNumber"
    err "-   $APP help|-h                                                           # show this message"
    err "-   $APP domains                                                           # list domains hosted by current AWS account"
    err "-   $APP domainlist|listdomain <domain>                                    # list A and CNAME records of a domain"
    err "-   $APP listA|lista <domain>                                              # list A records of a domain"
    err "-   $APP listcname|listCname|listCNAME <domain>                            # list CNAME records of a domain"
    err "-   $APP search <domain> <searchRegExpr>                                   # search the domain for CNAME and A records"
    err "-   $APP hostedzoneID|hostedZoneID|hostedzoneid|zoneID|zoneid <domain>     # list hostedzoneID"
}

function hostedzoneID() 
{
    domain=$1
    [[ $domain != *. ]] && domain=$domain.
    #echo domain:$domain > /dev/stderr
    aws route53 list-hosted-zones  | jq ".HostedZones[] | select(.Name  == \"$domain\").Id" | sed -e 's/\"//g' -e 's,/hostedzone/,,'
}

function listDomainType()
{
    _hostID=$1
    _domainType=$2   
    aws route53 list-resource-record-sets --hosted-zone-id $_hostID | jq ".ResourceRecordSets[] | select(.Type == \"$_domainType\") | select(.Name != \"\").Name+\":\"+.ResourceRecords[0].Value" | sed 's/\"//g'
}

function argCheck()
{
    if [ $# -lt 1 ] ; then
        err ERROR: number of args is $#
        usage
        exit 1
    fi
    for cmd in jq sed tr sort aws 
    do
        [ ! -x "$(which $cmd)" ] && err ERROR: required command $cmd not found. && exit 7
    done
}

function main()
{
    argCheck $@
    cmd="$1"
    case $cmd in
    domainlist|listdomain)
        [ $# -ne 2 ] && err ERROR: wrong number of arguments $# && usage && exit 4
        hostID=$(hostedzoneID $2)
        [ -z "$hostID" ] && err ERROR: hostID could not be determined && exit 10
        echo $(listDomainType $hostID CNAME) $(listDomainType $hostID A) | tr ' ' '\n' | sort
        ;;
    domains)    
        aws route53 list-hosted-zones  | jq '.HostedZones[].Name' | sed 's/\"//g' | sort
        ;;
    hostedzoneID|hostedZoneID|hostedzoneid|zoneID|zoneid)
        [ $# -ne 2 ] && err ERROR: wrong number of arguments $# && usage && exit 4
        hostedzoneID $2
        ;;
    help|-h)
        usage
        ;;
    lista|listA)
        [ $# -ne 2 ] && err ERROR: wrong number of arguments $# && usage && exit 4
        hostID=$(hostedzoneID $2)
        [ -z "$hostID" ] && err ERROR: hostID could not be determined && exit 10
        echo $(listDomainType $hostID A) | tr ' ' '\n' | sort
        ;;
    listcname|listCname|listCNAME)
        [ $# -ne 2 ] && err ERROR: wrong number of arguments $# && usage && exit 4
        hostID=$(hostedzoneID $2)
        [ -z "$hostID" ] && err ERROR: hostID could not be determined && exit 10
        echo $(listDomainType $hostID CNAME) | tr ' ' '\n' | sort
        ;;
    search)
        [ $# -ne 3 ] && err ERROR: wrong number of arguments $# && usage && exit 4
        hostID=$(hostedzoneID $2)
        [ -z "$hostID" ] && err ERROR: hostID could not be determined && exit 10
        echo $(listDomainType $hostID CNAME) $(listDomainType $hostID A) | tr ' ' '\n' | sort | egrep "$3"
        ;;
    version|-V)
        echo $APP:$APP_VERSION
        exit 3
        ;;
    *)
        err ERROR: unsupported command $cmd
        exit 2
        ;;
    esac
}

main $@